name: Build & Release Go Binaries

on:
  # Triggers the workflow when a new tag (e.g., v1.0.0) is pushed
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  BINARY_NAME: media-app # Matches the name in your Dockerfile
  ASSET_NAME: media-app-linux-amd64 # The name for the released file

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create the GitHub Release

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: 3. Build Go Binary (Linux/AMD64)
        # CGO_ENABLED=0 ensures a static, minimal binary
        # GOOS=linux GOARCH=amd64 targets a standard server environment
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ${{ env.BINARY_NAME }} main.go

      - name: 4. Create Deployment Archive
        # Bundle the binary and the templates folder into a single .tar.gz
        run: |
          # Ensure templates directory exists before packaging
          if [ ! -d "templates" ]; then
            echo "Error: 'templates' directory not found!"
            exit 1
          fi
          # Create the archive
          tar -czf ${{ env.ASSET_NAME }}.tar.gz ${{ env.BINARY_NAME }} templates/

      - name: 5. Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_NAME }}.tar.gz
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
